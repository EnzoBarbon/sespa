<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Vida Laboral</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            margin-bottom: 40px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        .step.active {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        .upload-section {
            border: 2px dashed #ddd;
            padding: 30px;
            text-align: center;
            border-radius: 5px;
        }
        .upload-section:hover {
            border-color: #007bff;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .editable-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .editable-table th, .editable-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .editable-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .editable-table select, .editable-table input[type="date"] {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .vacation-row {
            background-color: #fff3cd;
        }
        .contract-row {
            background-color: #d1ecf1;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        .remove-btn:hover {
            background-color: #c82333;
        }
        .add-row-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .results-section {
            display: none;
            margin-top: 30px;
        }
        .summary-card {
            background-color: #e7f3ff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .summary-card h3 {
            margin-top: 0;
            color: #0056b3;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .results-table th, .results-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .results-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .image-preview-section {
            display: none;
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .image-item {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            background-color: white;
            max-width: 500px;
        }
        .image-item img {
            max-width: 100%;
            height: auto;
            border-radius: 3px;
        }
        .image-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .image-data {
            margin-top: 10px;
        }
        .image-data table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .image-data table th,
        .image-data table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: left;
        }
        .image-data table th {
            background-color: #f0f0f0;
        }
        .image-editable-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        .image-editable-table th, .image-editable-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        .image-editable-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .image-editable-table select, .image-editable-table input[type="date"] {
            width: 100%;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
        }
        .image-remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 10px;
        }
        .image-remove-btn:hover {
            background-color: #c82333;
        }
        .image-add-section {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        .image-add-section select, .image-add-section input {
            margin: 2px;
            padding: 3px;
            font-size: 11px;
        }
        .image-add-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Extractor de Vida Laboral</h1>
        
        <!-- Step 1: Extract Data -->
        <div class="step active" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2>Extraer Datos</h2>
            </div>
            
            <div class="upload-options">
                <div class="upload-section">
                    <h3>Opci√≥n 1: Subir PDF de Vida Laboral</h3>
                    <p>Selecciona el archivo PDF del informe de vida laboral</p>
                    <form id="extractPdfForm" enctype="multipart/form-data">
                        <input type="file" id="pdfFile" name="pdf" accept=".pdf">
                        <br><br>
                        <button type="submit" id="extractPdfBtn">Extraer desde PDF</button>
                    </form>
                </div>

                <div class="upload-section" style="margin-top: 20px;">
                    <h3>Opci√≥n 2: Subir Im√°genes</h3>
                    <p>Selecciona m√∫ltiples im√°genes del informe de vida laboral</p>
                    <form id="extractImagesForm" enctype="multipart/form-data">
                        <input type="file" id="imageFiles" name="images" accept=".jpg,.jpeg,.png" multiple>
                        <br><br>
                        <button type="submit" id="extractImagesBtn">Extraer desde Im√°genes</button>
                    </form>
                </div>
            </div>

            <div class="loading" id="extractLoading">
                <p>‚è≥ Extrayendo datos... Por favor espera.</p>
            </div>

            <!-- Image Preview Section -->
            <div class="image-preview-section" id="imagePreviewSection">
                <h3>üì∏ Im√°genes Procesadas</h3>
                <p>Revisa las im√°genes y los datos extra√≠dos de cada una:</p>
                <div class="image-preview" id="imagePreview">
                </div>
            </div>
        </div>

        <!-- Step 2: Edit Data -->
        <div class="step" id="step2">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2>Revisar y Editar Datos Extra√≠dos</h2>
            </div>
            
            <p>Revisa los datos extra√≠dos y realiza cualquier correcci√≥n necesaria:</p>
            
            <table class="editable-table" id="editableTable">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Fecha Alta</th>
                        <th>Fecha Baja</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="editableTableBody">
                </tbody>
            </table>

            <div class="add-row-section">
                <h4>Agregar Nueva Fila</h4>
                <select id="newRowType">
                    <option value="vacation">Vacaciones</option>
                    <option value="contract">Contrato</option>
                </select>
                <input type="date" id="newRowFechaAlta" placeholder="Fecha Alta">
                <input type="date" id="newRowFechaBaja" placeholder="Fecha Baja">
                <button onclick="addNewRow()">Agregar Fila</button>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="calculateBtn" class="success" onclick="calculateVacationDays()">Calcular D√≠as de Vacaciones</button>
            </div>

            <div class="loading" id="calculateLoading">
                <p>‚è≥ Calculando d√≠as de vacaciones... Por favor espera.</p>
            </div>
        </div>

        <!-- Results -->
        <div class="results-section" id="results">
            <div class="summary-card">
                <h3>üìä Resultados</h3>
                <p><strong>Total de d√≠as de vacaciones no solapados:</strong> <span id="totalDays">0</span> d√≠as</p>
                <p><strong>N√∫mero de per√≠odos de vacaciones:</strong> <span id="totalPeriods">0</span> per√≠odos</p>
            </div>

            <h3>üèñÔ∏è Per√≠odos de Vacaciones No Solapados</h3>
            <table class="results-table" id="vacationTable">
                <thead>
                    <tr>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                        <th>D√≠as</th>
                    </tr>
                </thead>
                <tbody id="vacationTableBody">
                </tbody>
            </table>
        </div>

        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        let extractedData = [];
        let imageResults = [];

        // Step 1: Extract data from PDF
        document.getElementById('extractPdfForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }

            const formData = new FormData();
            formData.append('pdf', file);

            await extractData(formData, 'extractPdfBtn');
        });

        // Step 1: Extract data from images
        document.getElementById('extractImagesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('imageFiles');
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                alert('Por favor selecciona al menos una imagen');
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }

            await extractData(formData, 'extractImagesBtn');
        });

        async function extractData(formData, buttonId) {
            document.getElementById(buttonId).disabled = true;
            document.getElementById('extractLoading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('imagePreviewSection').style.display = 'none';

            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Error extrayendo datos');
                }

                extractedData = result.data;
                
                // Handle image results if present
                if (result.source === 'images' && result.image_results) {
                    imageResults = result.image_results;
                    displayImagePreviews();
                }
                
                populateEditableTable();
                activateStep2();
                
            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById(buttonId).disabled = false;
                document.getElementById('extractLoading').style.display = 'none';
            }
        }

        function populateEditableTable() {
            const tbody = document.getElementById('editableTableBody');
            tbody.innerHTML = '';

            extractedData.forEach((item, index) => {
                addRowToTable(item, index);
            });
        }

        function addRowToTable(item, index) {
            const tbody = document.getElementById('editableTableBody');
            const row = tbody.insertRow();
            row.className = item.type === 'vacation' ? 'vacation-row' : 'contract-row';
            row.dataset.index = index;

            // Type cell
            const typeCell = row.insertCell(0);
            const typeSelect = document.createElement('select');
            typeSelect.innerHTML = `
                <option value="vacation" ${item.type === 'vacation' ? 'selected' : ''}>Vacaciones</option>
                <option value="contract" ${item.type === 'contract' ? 'selected' : ''}>Contrato</option>
            `;
            typeSelect.onchange = function() {
                extractedData[index].type = this.value;
                row.className = this.value === 'vacation' ? 'vacation-row' : 'contract-row';
            };
            typeCell.appendChild(typeSelect);

            // Fecha Alta cell
            const fechaAltaCell = row.insertCell(1);
            const fechaAltaInput = document.createElement('input');
            fechaAltaInput.type = 'date';
            fechaAltaInput.value = convertToDateInput(item.fechaAlta);
            fechaAltaInput.onchange = function() {
                extractedData[index].fechaAlta = convertFromDateInput(this.value);
            };
            fechaAltaCell.appendChild(fechaAltaInput);

            // Fecha Baja cell
            const fechaBajaCell = row.insertCell(2);
            const fechaBajaInput = document.createElement('input');
            fechaBajaInput.type = 'date';
            fechaBajaInput.value = convertToDateInput(item.fechaBaja);
            fechaBajaInput.onchange = function() {
                extractedData[index].fechaBaja = convertFromDateInput(this.value);
            };
            fechaBajaCell.appendChild(fechaBajaInput);

            // Actions cell
            const actionsCell = row.insertCell(3);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Eliminar';
            removeBtn.onclick = function() {
                removeRow(index);
            };
            actionsCell.appendChild(removeBtn);
        }

        function convertToDateInput(dateStr) {
            if (!dateStr) return '';
            // Convert DD/MM/YYYY to YYYY-MM-DD
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return '';
        }

        function convertFromDateInput(dateStr) {
            if (!dateStr) return '';
            // Convert YYYY-MM-DD to DD/MM/YYYY
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return '';
        }

        function addNewRow() {
            const type = document.getElementById('newRowType').value;
            const fechaAlta = convertFromDateInput(document.getElementById('newRowFechaAlta').value);
            const fechaBaja = convertFromDateInput(document.getElementById('newRowFechaBaja').value);

            const newItem = {
                type: type,
                fechaAlta: fechaAlta,
                fechaBaja: fechaBaja
            };

            extractedData.push(newItem);
            addRowToTable(newItem, extractedData.length - 1);

            // Clear inputs
            document.getElementById('newRowFechaAlta').value = '';
            document.getElementById('newRowFechaBaja').value = '';
        }

        function removeRow(index) {
            extractedData.splice(index, 1);
            populateEditableTable(); // Refresh table with updated indices
        }

        function displayImagePreviews() {
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';
            
            imageResults.forEach((imageResult, imageIndex) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                
                imageItem.innerHTML = `
                    <h4>${imageResult.filename}</h4>
                    <img src="data:image/jpeg;base64,${imageResult.image_base64}" alt="${imageResult.filename}">
                    <div class="image-data">
                        <h5>Editar datos de esta imagen:</h5>
                        <table class="image-editable-table" id="imageTable_${imageIndex}">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Fecha Alta</th>
                                    <th>Fecha Baja</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="imageTableBody_${imageIndex}">
                            </tbody>
                        </table>
                        <div class="image-add-section">
                            <select id="imageNewRowType_${imageIndex}">
                                <option value="vacation">Vacaciones</option>
                                <option value="contract">Contrato</option>
                            </select>
                            <input type="date" id="imageNewRowFechaAlta_${imageIndex}" placeholder="Fecha Alta">
                            <input type="date" id="imageNewRowFechaBaja_${imageIndex}" placeholder="Fecha Baja">
                            <button class="image-add-btn" onclick="addImageRow(${imageIndex})">Agregar</button>
                        </div>
                    </div>
                `;
                
                previewContainer.appendChild(imageItem);
                
                // Populate the editable table for this image
                populateImageTable(imageIndex, imageResult.data);
            });
            
            document.getElementById('imagePreviewSection').style.display = 'block';
        }

        function populateImageTable(imageIndex, data) {
            const tbody = document.getElementById(`imageTableBody_${imageIndex}`);
            tbody.innerHTML = '';

            data.forEach((item, rowIndex) => {
                addImageRowToTable(imageIndex, item, rowIndex);
            });
        }

        function addImageRowToTable(imageIndex, item, rowIndex) {
            const tbody = document.getElementById(`imageTableBody_${imageIndex}`);
            const row = tbody.insertRow();
            row.className = item.type === 'vacation' ? 'vacation-row' : 'contract-row';
            row.dataset.imageIndex = imageIndex;
            row.dataset.rowIndex = rowIndex;

            // Type cell
            const typeCell = row.insertCell(0);
            const typeSelect = document.createElement('select');
            typeSelect.innerHTML = `
                <option value="vacation" ${item.type === 'vacation' ? 'selected' : ''}>Vacaciones</option>
                <option value="contract" ${item.type === 'contract' ? 'selected' : ''}>Contrato</option>
            `;
            typeSelect.onchange = function() {
                imageResults[imageIndex].data[rowIndex].type = this.value;
                row.className = this.value === 'vacation' ? 'vacation-row' : 'contract-row';
                updateExtractedData();
            };
            typeCell.appendChild(typeSelect);

            // Fecha Alta cell
            const fechaAltaCell = row.insertCell(1);
            const fechaAltaInput = document.createElement('input');
            fechaAltaInput.type = 'date';
            fechaAltaInput.value = convertToDateInput(item.fechaAlta);
            fechaAltaInput.onchange = function() {
                imageResults[imageIndex].data[rowIndex].fechaAlta = convertFromDateInput(this.value);
                updateExtractedData();
            };
            fechaAltaCell.appendChild(fechaAltaInput);

            // Fecha Baja cell
            const fechaBajaCell = row.insertCell(2);
            const fechaBajaInput = document.createElement('input');
            fechaBajaInput.type = 'date';
            fechaBajaInput.value = convertToDateInput(item.fechaBaja);
            fechaBajaInput.onchange = function() {
                imageResults[imageIndex].data[rowIndex].fechaBaja = convertFromDateInput(this.value);
                updateExtractedData();
            };
            fechaBajaCell.appendChild(fechaBajaInput);

            // Actions cell
            const actionsCell = row.insertCell(3);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'image-remove-btn';
            removeBtn.textContent = 'X';
            removeBtn.onclick = function() {
                removeImageRow(imageIndex, rowIndex);
            };
            actionsCell.appendChild(removeBtn);
        }

        function addImageRow(imageIndex) {
            const type = document.getElementById(`imageNewRowType_${imageIndex}`).value;
            const fechaAlta = convertFromDateInput(document.getElementById(`imageNewRowFechaAlta_${imageIndex}`).value);
            const fechaBaja = convertFromDateInput(document.getElementById(`imageNewRowFechaBaja_${imageIndex}`).value);

            const newItem = {
                type: type,
                fechaAlta: fechaAlta,
                fechaBaja: fechaBaja
            };

            imageResults[imageIndex].data.push(newItem);
            addImageRowToTable(imageIndex, newItem, imageResults[imageIndex].data.length - 1);
            updateExtractedData();

            // Clear inputs
            document.getElementById(`imageNewRowFechaAlta_${imageIndex}`).value = '';
            document.getElementById(`imageNewRowFechaBaja_${imageIndex}`).value = '';
        }

        function removeImageRow(imageIndex, rowIndex) {
            imageResults[imageIndex].data.splice(rowIndex, 1);
            populateImageTable(imageIndex, imageResults[imageIndex].data);
            updateExtractedData();
        }

        function updateExtractedData() {
            // Rebuild extractedData from all image results
            extractedData = [];
            imageResults.forEach(imageResult => {
                extractedData.push(...imageResult.data);
            });
            
            // Update the main editable table if it exists
            if (document.getElementById('editableTableBody')) {
                populateEditableTable();
            }
        }

        function activateStep2() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }

        // Step 2: Calculate vacation days
        async function calculateVacationDays() {
            document.getElementById('calculateBtn').disabled = true;
            document.getElementById('calculateLoading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'none';

            try {
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        records: extractedData
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Error calculando d√≠as de vacaciones');
                }

                displayResults(result);
                
            } catch (error) {
                document.getElementById('error').textContent = 'Error: ' + error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('calculateBtn').disabled = false;
                document.getElementById('calculateLoading').style.display = 'none';
            }
        }

        function displayResults(data) {
            document.getElementById('totalDays').textContent = data.total_non_overlapping_vacation_days;
            document.getElementById('totalPeriods').textContent = data.non_overlapping_vacation_periods.length;

            const vacationTableBody = document.getElementById('vacationTableBody');
            vacationTableBody.innerHTML = '';
            
            data.non_overlapping_vacation_periods.forEach(period => {
                const row = vacationTableBody.insertRow();
                row.insertCell(0).textContent = period.start;
                row.insertCell(1).textContent = period.end;
                row.insertCell(2).textContent = period.days;
            });

            if (data.non_overlapping_vacation_periods.length > 0) {
                const totalRow = vacationTableBody.insertRow();
                totalRow.style.fontWeight = 'bold';
                totalRow.style.backgroundColor = '#f8f9fa';
                totalRow.insertCell(0).textContent = '';
                totalRow.insertCell(1).textContent = 'TOTAL:';
                totalRow.insertCell(2).textContent = data.total_non_overlapping_vacation_days;
            }

            document.getElementById('results').style.display = 'block';
        }
    </script>
</body>
</html>